
<!DOCTYPE html>
<html>
<head>
    <title>GeoStats</title>
    <meta charset="utf-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="lib/leaflet/leaflet.css" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="lib/bootstrap/css/bootstrap.min.css" >
    <!-- Include the plugin's CSS and JS: -->
    <link rel="stylesheet" href="lib/bootstrap/css/bootstrap-3.0.3.min.css" type="text/css"/>
</head>
<body>
    <div id="content">
        <div id="map">
            <div id="map-header">
                <select id="layer-chooser" class="multiselect">
                    <option value="federalState">Federal state</option>
                    <option value="adminstrativeDistricts" >Administrative District</option>
                    <option value="districts" selected>District</option>
                </select>
            </div>
            <div id="map-content">
                <div id="map-inner-shadow"></div>                
            </div>
            <div id="map-footer"></div>
        </div>
        <div id="data">

            <!-- Nav tabs -->
            <ul class="nav nav-tabs">
              <li class="active"><a href="#home" data-toggle="tab">Home</a></li>
              <li><a href="#info" data-toggle="tab" id="nav-button-info">Info</a></li>
              <li><a href="#statistics" data-toggle="tab">Statistics</a></li>
              <li><a href="#geometry-info" data-toggle="tab">Results</a></li>
            </ul>

            <!-- tab panes -->
            <div class="tab-content">
                <div class="tab-pane fade in active" id="home">
                    <div class="page-header">
                        <h1>GeoStats<small> Visualizing interlinked RDF data cubes on maps</small></h1>
                        <ul>
                            <li>http://epp.eurostat.ec.europa.eu/portal/page/portal/nuts_nomenclature/introduction</li>
                            <li>http://ec.europa.eu/eurostat/ramon/nomenclatures/index.cfm?TargetUrl=LST_NOM_DTL&StrNom=NUTS_22&StrLanguageCode=EN&IntPcKey=30634779&StrLayoutCode=HIERARCHIC</li>
                            <li>https://www.regionalstatistik.de/genesis/online;jsessionid=1012C26EDAD38DE26DB574B8EEF257E1?Menu=Willkommen</li>
                            <li>http://eur-lex.europa.eu/LexUriServ/LexUriServ.do?uri=OJ:L:2013:342:0001:0057:DE:PDF</li>
                        </ul>
                    </div>
                </div>
                <div class="tab-pane fade" id="info">
                  
                </div>
                <div class="tab-pane fade" id="statistics">
                  Select a statistic
                </div>
                <div class="tab-pane fade" id="geometry-info">
                    See the results
                </div>
            </div>
        </div>    
    </div>
    

    <script src="lib/leaflet/leaflet.js"></script>
    <script src="lib/jquery/jquery-1.10.2.min.js"></script>
    <script src="lib/underscore/underscore-min.js"></script>
    <script src="lib/bootstrap/js/bootstrap.min.js"></script>
    <script src="lib/bootstrap/js/bootstrap-multiselect.js"></script>
    <script>

    $(document).ready(function() {

        var entities = '';
        var map = L.map('map-content', {
            center: [51.399206, 10.349121],
            zoom: 6,
            maxZoom: 18,
            minZoom: 1,
            dragging : true,
            zoomControl : true
        });

        var sourcePoints = L.featureGroup().addTo(map);

        L.tileLayer('http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/96931/256/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '&copy; <a href="http://openstreetmap.org">OSM</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>'
        }).addTo(map);

        $('#layer-chooser').multiselect({
            onChange: function(element, checked) {
                
                sourcePoints.clearLayers();
                
                _.each(entities[$('#layer-chooser').val()], function (district) {

                    var color = typeof district.kinderGarten === 'undefined' ? getRandomColor() : 
                        getColorLuminance('00FF4C', 0 - (1 - (district.kinderGarten)));

                    var polygon = L.polygon(district.sgeo, {stroke: false, fillColor: color, fillOpacity: 1.0});
                    polygon.addTo(sourcePoints)
                    polygon.district = district;
                    polygon.on('click', displayPolygonInfo);
                });
            }
        });

        $.getJSON('data/geometries.json', function(data){

            entities = data;

            console.log(entities);

            // get selection from layer selector and display the correct layer
            _.each(_.values(entities[$('#layer-chooser').val()]), function (district) {

                var color = typeof district.kinderGarten === 'undefined' ? getRandomColor() : 
                    getColorLuminance('00FF4C', 0 - (1 - (district.kinderGarten)));

                    color = "black";

                var polygon = L.multiPolygon(district.sgeo, {stroke: false, fillColor: color, fillOpacity: 1.0});
                polygon.addTo(sourcePoints);
                polygon.district = district;
                polygon.on('click', displayPolygonInfo);
            });
        });

        function displayPolygonInfo() {

            $('#info').html(getPopupHtml(this.district));
            $('#nav-button-info').click();
        }
    });

    function getColorLuminance(hex, lum) {

        // validate hex string
        hex = String(hex).replace(/[^0-9a-f]/gi, '');
        if (hex.length < 6) {
            hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
        }
        lum = lum || 0;

        // convert to decimal and change luminosity
        var rgb = "#", c, i;
        for (i = 0; i < 3; i++) {
            c = parseInt(hex.substr(i*2,2), 16);
            c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
            rgb += ("00"+c).substr(c.length);
        }

        return rgb;
    }

    function getRandomColor() {
        var letters = '0123456789ABCDEF'.split('');
        var color = '#';
        for (var i = 0; i < 6; i++ ) {
            color += letters[Math.round(Math.random() * 15)];
        }
        return color;
    }

    function getPopupHtml(area) {

        var html =
            "<div>" +
                "<h1><a href='"+area.uri+"'>" + area.label + "</a></h1>" +
                "<div>" +
                    "<img class='district-image' src='" +area.img + "'/>" +
                    "<p>" + area.comment + "</p>" +
                    "<div style='clear: both;'/>" +
                    "<dl>" + 
                        "<dt>Homepage</dt>" +
                        "<dd><a href='" + area.url + "'>"+area.url+"</a></dd>"+
                    "</dl>" +
                "</div>" +    
            "</div>";

        return html;
    }

    </script>
</body>
</html>
